<!DOCTYPE html>
<html>
<head>
    <title>Easing Tool</title>
    <script src="../bin/lola.js"></script>
    <script src="../lola/agents/drag.js"></script>
    <script>
        (function( lola ) {
            var $ = lola;
            var page = {
                clients: {},
                spline: null,
                preinitialize: function() {
                    lola.debug('lola.page::preinitialize');
                    if ( !lola ) throw new Error( 'lola not defined!' );

                    //do agent preinitialization



                    //remove initialization method
                    delete lola.agent.page.preinitialize;
                },

                initialize: function() {
                    lola.debug('lola.agent.page::initialize');
                    //this framework is dependent on lola framework
                    if ( !lola ) throw new Error( 'lola not defined!' );

                    //set up styles
                    var g = lola.graphics;
                    g.registerStyle( 'gridBg', { fillStyle: "#FFFFFF",strokeStyle: "#CCCCCC"} );
                    g.registerStyle( 'mnrGrid', {strokeStyle: "#F0F0F0"} );
                    g.registerStyle( 'mjrGrid', {strokeStyle: "#EEEEEE"} );
                    g.registerStyle( 'axis', {strokeStyle: "#CCCCCC"} );
                    g.registerStyle( 'endPt', {strokeStyle: "#666666", fillStyle:"#990000"} );
                    g.registerStyle( 'middlePt', {strokeStyle: "#666666", fillStyle:"#009900"} );
                    g.registerStyle( 'ctrlPt', {strokeStyle: "#666666", fillStyle:"#000099"} );
                    g.registerStyle( 'spline', {strokeStyle: "#666666", lineWidth:3} );
                    g.registerStyle( 'ctrl', {strokeStyle: "#AAAAAA", lineWidth:1} );

                    g.registerRoutine( 'point', function( ctx ){
                        ctx.beginPath();
                        ctx.arc(6,6,6,0,2*Math.PI,false);
                        ctx.fill();
                        ctx.stroke();
                        ctx.closePath();
                    } );

                    //do agent initialization
                    $("body").assignAgent( this.getNamespace() );


                    //remove initialization method
                    delete lola.agent.page.initialize;
                },

                getNamespace: function() {
                    return "page";
                },

                getDependencies: function() {
                    return ['graphics','chart','math','math.point'];
                },

                sign: function( client ) {
                    var $client = $(client);
                    $client.identify();
                    if (this.client == null) {

                        //not a client yet
                        this.client = client;
                        var start = new lola.graphics.SplinePoint(50,450,0,0,100,0);
                        var middle = new lola.graphics.SplinePoint(250,250,100,-Math.PI/4,100,undefined);
                        var end = new lola.graphics.SplinePoint(450,50,100,0,100,0);
                        this.spline = new lola.graphics.Spline([start, middle, end], false);

                        //do setup
                        $('canvas').register2dContext();
                        this.drawGrid(400,400);
                        this.createPoints();
                        this.drawCurves();
                        //add listeners


                    }
                },

                drop: function( client ) {
                    var $client = $(client);
                    if (this.clients[ client.id ] ) {
                        $client.removeData( this.getNamespace() );

                        //remove listeners

                        this.client = null;
                    }
                },

                drawGrid: function(w,h){
                    var g = lola.graphics;
                    g.setContext('grid');

                    //background
                    g.applyStyle( 'gridBg' );
                    g.strokeRect( 50,50,w,h );
                    g.fillRect( 50,50,w,h );

                    //minor grid
                    g.applyStyle( 'mnrGrid' );
                    g.draw( new lola.chart.Grid(50,50,w,h,10, lola.chart.Grid.HORIZONTAL | lola.chart.Grid.VERTICAL ));

                    //major grid
                    g.applyStyle( 'mjrGrid' );
                    g.draw( new lola.chart.Grid(50,50,w,h,50, lola.chart.Grid.HORIZONTAL ));
                    g.draw( new lola.chart.Grid(50,50,w,h,w/10, lola.chart.Grid.VERTICAL ));

                    //axis
                    g.applyStyle( 'axis' );
                    g.draw( new lola.chart.Axis(50,50,w,"max",{x:-8,y:2}) );
                    g.draw( new lola.chart.Axis(50,50+h/4,w,"end",{x:-8,y:2}) );
                    g.draw( new lola.chart.Axis(50,50+3*h/4,w,"start",{x:-8,y:2}) );
                    g.draw( new lola.chart.Axis(50,50+h,w,"min",{x:-8,y:2}) );
                    g.draw( new lola.chart.Axis(50,50,h,"0",{x:0,y:15}, lola.chart.Axis.VERTICAL ) );
                    g.draw( new lola.chart.Axis(50+w,50,h,"1",{x:0,y:15}, lola.chart.Axis.VERTICAL ) );
                },

                createPoints: function(){
                    $('#pointHolder').html("");
                    //reset points
                    var $pointHolder = $('#pointHolder').html("");
                    var points = this.spline.getPoints();
                    var spl = points.length;
                    var last = points.length-1;
                    for (var i=0; i<spl; i++ ){
                        this.createPointUI( i, points[i], (last == i) );
                    }
                },

                createPointUI: function( index, point, last ) {
                    var $pointHolder = $('#pointHolder');
                    var g = lola.graphics;

                    //create canvases
                    var c1 = document.createElement('canvas');
                    var c2 = document.createElement('canvas');
                    var c3 = document.createElement('canvas');
                    c1.width = 12;
                    c2.width = 12;
                    c3.width = 12;
                    c1.height = 12;
                    c2.height = 12;
                    c3.height = 12;

                    g.setContext( c2.getContext('2d') );
                    g.applyStyle( (index == 0 || last)?'endPt':'middlePt' );
                    g.executeRoutine( 'point' );
                    var c2p = lola.math.point.add( point.getAnchor(), -6 );
                    $(c2).identify().
                            addClass('point').
                            style('top',c2p.y+'px').
                            style('left',c2p.x+'px');

                    if (index > 0 && !last ){
                        //moveable point
                        $(c2).assignAgent('drag').
                                addClass('draggable').
                                putData({index:index, type:'anchor', entry:c1, anchor:c2, exit:c3},'page').
                                addListener( 'dragstart', this.handlePointDragStart, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragmove', this.handlePointDragMove, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragend', this.handlePointDragEnd, false, lola.event.PRIORITY_LAST, this );

                    }
                    $pointHolder.appendChild( c2 );

                    if ( index > 0) {
                        g.setContext( c1.getContext('2d') );
                        g.applyStyle( 'ctrlPt' );
                        g.executeRoutine( 'point' );
                        var c1p = lola.math.point.add( point.getControl1(), -6 );
                        $(c1).identify().
                                assignAgent('drag').
                                addClass('point').
                                addClass('draggable').
                                style('top',c1p.y+'px').
                                style('left',c1p.x+'px').
                                putData({index:index, type:'entry', entry:c1, anchor:c2, exit:c3},'page').
                                addListener( 'dragstart', this.handlePointDragStart, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragmove', this.handlePointDragMove, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragend', this.handlePointDragEnd, false, lola.event.PRIORITY_LAST, this );
                        $pointHolder.appendChild( c1 );
                    }

                    if ( !last) {
                        g.setContext( c3.getContext('2d') );
                        g.applyStyle( 'ctrlPt' );
                        g.executeRoutine( 'point' );
                        var c3p = lola.math.point.add( point.getControl2(), -6);
                        $(c3).identify().
                                assignAgent('drag').
                                addClass('point').
                                addClass('draggable').
                                style('top',c3p.y+'px').
                                style('left',c3p.x+'px').
                                putData({index:index, type:'exit', entry:c1, anchor:c2, exit:c3},'page').
                                addListener( 'dragstart', this.handlePointDragStart, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragmove', this.handlePointDragMove, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragend', this.handlePointDragEnd, false, lola.event.PRIORITY_LAST, this );
                        $pointHolder.appendChild( c3 );
                    }


                },

                handlePointDragStart: function(event){


                    var data = $(event.currentTarget).getData('page');
                    var xMin=50, xMax=450, yMin=44, yMax=444;
                    var exit = {x:50,y:0};
                    var entry = {x:450,y:0};
                    var anchor = this.spline.getPoint(data.index).getAnchor();
                    if (data.index > 0)
                        exit = this.spline.getPoint(data.index-1).getControl2();
                    if (data.index < this.spline.getPoints().length - 1 )
                        entry = this.spline.getPoint(data.index+1).getControl1();

                    switch( data.type ){
                        case "entry":
                            xMax = anchor.x;
                            xMin = exit.x;
                            break;

                        case "anchor":
                            xMax = entry.x;
                            xMin = exit.x;
                            break;

                        case "exit":
                            xMax = entry.x;
                            xMin = anchor.x;
                            break;
                    }
                    xMax -= 6;
                    xMin -= 6;

                    lola.agent.drag.setBounds(xMin, xMax, yMin, yMax);
                },


                handlePointDragMove: function(event){
                    var data = $(event.currentTarget).getData('page');
                    var point = this.spline.getPoint(data.index);
                    var $c1 = $(data.entry);
                    var $c2 = $(data.anchor);
                    var $c3 = $(data.exit);
                    var bounds = lola.agent.drag.getBounds();
                    var prev, next, pnt, vct, entry, exit, anchor = point.getAnchor();

                    if (data.index > 0){
                        prev = this.spline.getPoint( data.index - 1 );
                    }
                    if (data.index < this.spline.getPoints().length-1 ){
                        next = this.spline.getPoint( data.index + 1 );
                    }

                    switch (data.type){
                        case "anchor":
                            anchor.x = parseInt( $c2.style("left").replace(/px/g,""))+6;
                            anchor.y = parseInt( $c2.style("top").replace(/px/g,""))+6;
                            break;
                        case "entry":
                            pnt = new lola.graphics.Point( parseInt( $c1.style("left").replace(/px/g,""))+6,
                                    parseInt( $c1.style("top").replace(/px/g,""))+6 );
                            vct = lola.math.point.subtract( anchor, pnt ).toVector();
                            point.setAngle( vct.angle );
                            point.entry.velocity = vct.velocity;
                            break;
                        case "exit":
                            pnt = new lola.graphics.Point( parseInt( $c3.style("left").replace(/px/g,""))+6,
                                    parseInt( $c3.style("top").replace(/px/g,""))+6 );
                            vct = lola.math.point.subtract( pnt, anchor ).toVector();
                            point.setAngle( vct.angle );
                            point.exit.velocity = vct.velocity;
                            break;
                    }


                    entry = point.getControl1();
                    exit = point.getControl2();
                    var xMin = prev ? prev.getControl2().x : bounds.xMin;
                    var xMax = next ? next.getControl1().x : bounds.xMax;
                    if (entry.x < xMin ){
                        point.entry.velocity =  (point.anchor.x - xMin) / Math.cos(point.entry.angle);
                        entry = point.getControl1();
                    }

                    if (exit.x > xMax ){
                        point.exit.velocity =  (xMax - point.anchor.x) / Math.cos(point.exit.angle);
                        exit = point.getControl2();
                    }

                    if (entry.y < bounds.yMin+6){
                        point.entry.velocity =  (point.anchor.y - bounds.yMin) / Math.sin(point.entry.angle);
                        entry = point.getControl1();
                    }
                    else if( entry.y > bounds.yMax-6 ){
                        point.entry.velocity =  (bounds.yMax - point.anchor.y) / Math.sin(point.entry.angle);
                        entry = point.getControl1();
                    }

                    if (exit.y < bounds.yMin+6){
                        point.exit.velocity =  (point.anchor.y - bounds.yMin) / Math.sin(point.exit.angle);
                        exit = point.getControl2();
                    }
                    else if( exit.y > bounds.yMax-6 ){
                        point.exit.velocity =  (bounds.yMax - point.anchor.y) / Math.sin(point.exit.angle);
                        exit = point.getControl2();
                    }

                    $c1.style("left", entry.x-6+"px").style("top", entry.y-6+"px");
                    $c2.style("left", anchor.x-6+"px").style("top", anchor.y-6+"px");
                    $c3.style("left", exit.x-6+"px").style("top", exit.y-6+"px");


                    this.drawCurves();

                },

                handlePointDragEnd: function(event){
                    var data = $(event.currentTarget).getData('page');
                    $('#pointHolder').appendChild(event.currentTarget);

                    console.log('handlePointDragEnd: '+data.type);
                    if (data.type == "anchor")
                        $(event.currentTarget).style('zIndex',20);
                    else
                        $(event.currentTarget).style('zIndex',25);

                },

                drawCurves: function(){
                    var g = lola.graphics;
                    g.setContext('curves');
                    g.clear();
                    g.applyStyle('spline');
                    g.draw( this.spline, g.Spline.STROKE );
                }

            };

            //register module
            lola.agent.registerAgent( page );

        })( lola );
    </script>
    <style>
        * { padding: 0; margin: 0; }
        p { margin: 10px 0; }
        input{ vertical-align: middle; }
        html{ background-color: rgb(245,245,245); }

        #grid, #curves, #pointHolder
        {
            position:absolute;
            top: 0;
            left: 0;
       }

        #pointHolder {
            width: 851px;
            height: 500px;
        }

        .draggable {
            cursor: move;
        }

        .point {
            position: absolute;
        }

    </style>
</head>
<body>
<canvas id="grid" width="851" height="500"></canvas>
<canvas id="curves" width="851" height="500"></canvas>
<div id="pointHolder">

</div>
</body>
</html>