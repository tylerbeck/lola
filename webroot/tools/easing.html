<!DOCTYPE html>
<html>
<head>
    <title>Easing Tool</title>
    <script src="../bin/lola.js"></script>
    <script src="../lola/agents/drag.js"></script>
    <script>
        (function( lola ) {
            var $ = lola;
            var page = {
                clients: {},
                spline: null,
                preinitialize: function() {
                    lola.debug('lola.page::preinitialize');
                    if ( !lola ) throw new Error( 'lola not defined!' );

                    //do agent preinitialization



                    //remove initialization method
                    delete lola.agent.page.preinitialize;
                },

                initialize: function() {
                    lola.debug('lola.agent.page::initialize');
                    //this framework is dependent on lola framework
                    if ( !lola ) throw new Error( 'lola not defined!' );

                    //set up styles
                    var g = lola.graphics;
                    g.registerStyle( 'gridBg', { fillStyle: "#FFFFFF",strokeStyle: "#CCCCCC"} );
                    g.registerStyle( 'mnrGrid', {strokeStyle: "#F0F0F0"} );
                    g.registerStyle( 'mjrGrid', {strokeStyle: "#EEEEEE"} );
                    g.registerStyle( 'axis', {strokeStyle: "#CCCCCC"} );
                    g.registerStyle( 'endPt', {strokeStyle: "#666666", fillStyle:"#990000"} );
                    g.registerStyle( 'middlePt', {strokeStyle: "#666666", fillStyle:"#009900"} );
                    g.registerStyle( 'ctrlPt', {strokeStyle: "#666666", fillStyle:"#000099"} );
                    g.registerStyle( 'spline', {strokeStyle: "#666666", lineWidth:3} );
                    g.registerStyle( 'ctrl', {strokeStyle: "#AAAAAA", lineWidth:1} );

                    g.registerRoutine( 'point', function( ctx ){
                        ctx.beginPath();
                        ctx.arc(6,6,6,0,2*Math.PI,false);
                        ctx.fill();
                        ctx.stroke();
                        ctx.closePath();
                    } );

                    //do agent initialization
                    $("body").assignAgent( this.getNamespace() );


                    //remove initialization method
                    delete lola.agent.page.initialize;
                },

                getNamespace: function() {
                    return "page";
                },

                getDependencies: function() {
                    return ['graphics','chart','math','math.point'];
                },

                sign: function( client ) {
                    var $client = $(client);
                    $client.identify();
                    if (this.client == null) {

                        //not a client yet
                        this.client = client;
                        var start = new lola.graphics.SplinePoint(50,350,0,0,100,0);
                        //var middle = new lola.graphics.SplinePoint(250,250,100,-Math.PI/4,100,undefined);
                        var end = new lola.graphics.SplinePoint(450,150,100,0,100,0);
                        //this.spline = new lola.graphics.Spline([start,middle, end], false);
                        this.spline = new lola.graphics.Spline([start, end], false);

                        //do setup
                        $('canvas').register2dContext();
                        this.drawGrid(400,400);
                        this.createPoints();
                        this.drawCurves();
                        this.updateFunctions();

                        //add listeners
                        $("#testBtn").addListener('click',this.test);

                    }
                },

                drop: function( client ) {
                    var $client = $(client);
                    if (this.clients[ client.id ] ) {
                        $client.removeData( this.getNamespace() );

                        //remove listeners

                        this.client = null;
                    }
                },

                drawGrid: function(w,h){
                    var g = lola.graphics;
                    g.setContext('grid');

                    //background
                    g.applyStyle( 'gridBg' );
                    g.strokeRect( 50,50,w,h );
                    g.fillRect( 50,50,w,h );

                    //minor grid
                    g.applyStyle( 'mnrGrid' );
                    g.draw( new lola.chart.Grid(50,50,w,h,10, lola.chart.Grid.HORIZONTAL | lola.chart.Grid.VERTICAL ));

                    //major grid
                    g.applyStyle( 'mjrGrid' );
                    g.draw( new lola.chart.Grid(50,50,w,h,50, lola.chart.Grid.HORIZONTAL ));
                    g.draw( new lola.chart.Grid(50,50,w,h,w/10, lola.chart.Grid.VERTICAL ));

                    //axis
                    g.applyStyle( 'axis' );
                    g.draw( new lola.chart.Axis(50,50,w,"max",{x:-8,y:2}) );
                    g.draw( new lola.chart.Axis(50,50+h/4,w,"end",{x:-8,y:2}) );
                    g.draw( new lola.chart.Axis(50,50+3*h/4,w,"start",{x:-8,y:2}) );
                    g.draw( new lola.chart.Axis(50,50+h,w,"min",{x:-8,y:2}) );
                    g.draw( new lola.chart.Axis(50,50,h,"0",{x:0,y:15}, lola.chart.Axis.VERTICAL ) );
                    g.draw( new lola.chart.Axis(50+w,50,h,"1",{x:0,y:15}, lola.chart.Axis.VERTICAL ) );
                },

                createPoints: function(){
                    $('#pointHolder').html("");
                    //reset points
                    var $pointHolder = $('#pointHolder').html("");
                    var points = this.spline.getPoints();
                    var spl = points.length;
                    var last = points.length-1;
                    for (var i=0; i<spl; i++ ){
                        this.createPointUI( i, points[i], (last == i) );
                    }
                },

                createPointUI: function( index, point, last ) {
                    var $pointHolder = $('#pointHolder');
                    var g = lola.graphics;

                    //create canvases
                    var c1 = document.createElement('canvas');
                    var c2 = document.createElement('canvas');
                    var c3 = document.createElement('canvas');
                    c1.width = 12;
                    c2.width = 12;
                    c3.width = 12;
                    c1.height = 12;
                    c2.height = 12;
                    c3.height = 12;

                    g.setContext( c2.getContext('2d') );
                    g.applyStyle( (index == 0 || last)?'endPt':'middlePt' );
                    g.executeRoutine( 'point' );
                    var c2p = lola.math.point.add( point.getAnchor(), -6 );
                    $(c2).identify().
                            addClass('point').
                            style('top',c2p.y+'px').
                            style('left',c2p.x+'px');

                    if (index > 0 && !last ){
                        //moveable point
                        $(c2).assignAgent('drag').
                                addClass('draggable').
                                putData({index:index, type:'anchor', entry:c1, anchor:c2, exit:c3},'page').
                                addListener( 'dragstart', this.handlePointDragStart, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragmove', this.handlePointDragMove, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragend', this.handlePointDragEnd, false, lola.event.PRIORITY_LAST, this );

                    }
                    $pointHolder.appendChild( c2 );

                    if ( index > 0) {
                        g.setContext( c1.getContext('2d') );
                        g.applyStyle( 'ctrlPt' );
                        g.executeRoutine( 'point' );
                        var c1p = lola.math.point.add( point.getControl1(), -6 );
                        $(c1).identify().
                                assignAgent('drag').
                                addClass('point').
                                addClass('draggable').
                                style('top',c1p.y+'px').
                                style('left',c1p.x+'px').
                                putData({index:index, type:'entry', entry:c1, anchor:c2, exit:c3},'page').
                                addListener( 'dragstart', this.handlePointDragStart, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragmove', this.handlePointDragMove, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragend', this.handlePointDragEnd, false, lola.event.PRIORITY_LAST, this );
                        $pointHolder.appendChild( c1 );
                    }

                    if ( !last) {
                        g.setContext( c3.getContext('2d') );
                        g.applyStyle( 'ctrlPt' );
                        g.executeRoutine( 'point' );
                        var c3p = lola.math.point.add( point.getControl2(), -6);
                        $(c3).identify().
                                assignAgent('drag').
                                addClass('point').
                                addClass('draggable').
                                style('top',c3p.y+'px').
                                style('left',c3p.x+'px').
                                putData({index:index, type:'exit', entry:c1, anchor:c2, exit:c3},'page').
                                addListener( 'dragstart', this.handlePointDragStart, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragmove', this.handlePointDragMove, false, lola.event.PRIORITY_FIRST, this ).
                                addListener( 'dragend', this.handlePointDragEnd, false, lola.event.PRIORITY_LAST, this );
                        $pointHolder.appendChild( c3 );
                    }


                },

                handlePointDragStart: function(event){
                    var data = $(event.currentTarget).getData('page');
                    var xMin=50, xMax=450, yMin=44, yMax=444;
                    var next = {x:50,y:0};
                    var prev = {x:450,y:0};
                    var anchor = this.spline.getPoint(data.index).getAnchor();
                    if (data.index > 0)
                        prev = this.spline.getPoint(data.index-1).getAnchor();
                    if (data.index < this.spline.getPoints().length - 1 )
                        next = this.spline.getPoint(data.index+1).getAnchor();

                    switch( data.type ){
                        case "entry":
                            xMax = anchor.x;
                            xMin = prev.x;
                            break;

                        case "anchor":
                            xMax = next.x;
                            xMin = prev.x;
                            break;

                        case "exit":
                            xMax = next.x;
                            xMin = anchor.x;
                            break;
                    }
                    xMax -= 6;
                    xMin -= 6;

                    lola.agent.drag.setBounds(xMin, xMax, yMin, yMax);
                },


                handlePointDragMove: function(event){
                    var data = $(event.currentTarget).getData('page');
                    var point = this.spline.getPoint(data.index);
                    var $c1 = $(data.entry);
                    var $c2 = $(data.anchor);
                    var $c3 = $(data.exit);
                    var bounds = lola.agent.drag.getBounds();
                    var prev, next, pnt, vct, entry, exit, anchor = point.getAnchor();

                    if (data.index > 0){
                        prev = this.spline.getPoint( data.index - 1 );
                    }
                    if (data.index < this.spline.getPoints().length-1 ){
                        next = this.spline.getPoint( data.index + 1 );
                    }

                    switch (data.type){
                        case "anchor":
                            anchor.x = parseInt( $c2.style("left").replace(/px/g,""))+6;
                            anchor.y = parseInt( $c2.style("top").replace(/px/g,""))+6;
                            break;
                        case "entry":
                            pnt = new lola.graphics.Point( parseInt( $c1.style("left").replace(/px/g,""))+6,
                                    parseInt( $c1.style("top").replace(/px/g,""))+6 );
                            vct = lola.math.point.subtract( anchor, pnt ).toVector();
                            point.setAngle( vct.angle );
                            point.entry.velocity = vct.velocity;
                            break;
                        case "exit":
                            pnt = new lola.graphics.Point( parseInt( $c3.style("left").replace(/px/g,""))+6,
                                    parseInt( $c3.style("top").replace(/px/g,""))+6 );
                            vct = lola.math.point.subtract( pnt, anchor ).toVector();
                            point.setAngle( vct.angle );
                            point.exit.velocity = vct.velocity;
                            break;
                    }


                    entry = point.getControl1();
                    exit = point.getControl2();
                    var xMin = prev ? prev.getAnchor().x : bounds.xMin;
                    var xMax = next ? next.getAnchor().x : bounds.xMax;

                    if (entry.x < xMin ){
                        point.entry.velocity =  (point.anchor.x - xMin) / Math.cos(point.entry.angle);
                        entry = point.getControl1();
                    }

                    if (exit.x > xMax ){
                        point.exit.velocity =  (xMax - point.anchor.x) / Math.cos(point.exit.angle);
                        exit = point.getControl2();
                    }

                    if (entry.y < bounds.yMin+6){
                        point.entry.velocity = Math.abs((point.anchor.y - bounds.yMin - 6) / Math.sin(point.entry.angle));
                        entry = point.getControl1();
                    }
                    else if( entry.y > bounds.yMax+6){
                        point.entry.velocity = Math.abs((bounds.yMax - point.anchor.y + 6) / Math.sin(point.entry.angle));
                        entry = point.getControl1();
                    }

                    if (exit.y < bounds.yMin+6){
                        point.exit.velocity = Math.abs((point.anchor.y - bounds.yMin - 6) / Math.sin(point.exit.angle));
                        exit = point.getControl2();
                    }
                    else if( exit.y > bounds.yMax+6){
                        point.exit.velocity = Math.abs((bounds.yMax - point.anchor.y + 6) / Math.sin(point.exit.angle));
                        exit = point.getControl2();
                    }

                    $c1.style("left", entry.x-6+"px").style("top", entry.y-6+"px");
                    $c2.style("left", anchor.x-6+"px").style("top", anchor.y-6+"px");
                    $c3.style("left", exit.x-6+"px").style("top", exit.y-6+"px");


                    this.drawCurves();

                },

                handlePointDragEnd: function(event){
                    var data = $(event.currentTarget).getData('page');
                    $('#pointHolder').appendChild(event.currentTarget);
                    if (data.type == "anchor")
                        $(event.currentTarget).style('zIndex',20);
                    else
                        $(event.currentTarget).style('zIndex',25);

                    this.updateFunctions();

                },

                drawCurves: function(){
                    var g = lola.graphics;
                    g.setContext('curves');
                    g.clear();
                    g.applyStyle('ctrl');
                    g.draw( this.spline, g.Spline.CONTROLS );

                    g.applyStyle('spline');
                    g.draw( this.spline, g.Spline.STROKE );
                },

                updateFunctions: function(){
                    //normalize points
                    var normX = [];
                    var normY = [];

                    var pts = this.spline.getPoints();
                    var spl = pts.length;
                    for (var i=0; i<spl; i++ ){
                        var p1 = pts[i].getControl1();
                        var p2 = pts[i].getAnchor();
                        var p3 = pts[i].getControl2();
                        normX.push( (p1.x - 50)/400 );
                        normY.push( 1-(p1.y - 150)/200 );
                        normX.push( (p2.x - 50)/400 );
                        normY.push( 1-(p2.y - 150)/200 );
                        normX.push( (p3.x - 50)/400 );
                        normY.push( 1-(p3.y - 150)/200 );
                    }

                    var sect = normX.length /  3 - 1;
                    var sections = [];
                    var fnc =   "function ( t, v, c, d ) {\n"+
                            "       t /= d;\n"+
                            "       var it;\n";

                    for (var s=0; s<sect; s++) {
                        var pn = s*3;
                        var time = normX[pn+4];
                        var st = normX[pn+1];
                        sections.push(
                                "if (t<="+time+"){\n"+
                                "       t = (t-"+st+")/"+(time-st)+";\n"+
                                "       it = 1-t;\n"+
                                //add curve equation for this section
                                "       return v+c*(("+normY[pn+1]+"*it*it*it) + \n"+
                                "              ("+normY[pn+2]+"*3*it*it*t) + \n"+
                                "              ("+normY[pn+3]+"*3*it*t*t) + \n"+
                                "              ("+normY[pn+4]+"*t*t*t*t)) ; \n"+

                                "   }\n" );
                    }
                    fnc += "   "+sections.join("   else ");
                    fnc +=      "}\n";
                    lola.evaluate("lola.agent.page.testFn = "+fnc);
                    $("#easing").html( fnc );
                },
                testFn: null,
                testStart: null,
                testDuration: 2000,
                testFrom: 350,
                testDelta: 150,
                testCallback: function(){
                    if (!lola.agent.page.testStart)
                        lola.agent.page.testStart = (new Date()).getTime();
                    var now = (new Date()).getTime();
                    var elapsed = now - lola.agent.page.testStart;
                    if (elapsed > lola.agent.page.testDuration)
                        elapsed = lola.agent.page.testDuration;
                    var val = lola.agent.page.testFn( elapsed, lola.agent.page.testFrom, -200, lola.agent.page.testDuration );
                    var val2 = elapsed / 2000 * 400 + 49;
                    console.log(val);
                    $('#test').style('height', val+"px").style('left',val2+"px");

                    if (elapsed < lola.agent.page.testDuration)
                        setTimeout( lola.agent.page.testCallback, 30 );
                    else
                        lola.agent.page.testStart = null;

                },
                test: function(){
                    if (lola.agent.page.testFn){
                        console.log('TEST');
                        setTimeout( lola.agent.page.testCallback, 1000 );
                        $('#test').style('height', "350px");
               }
                }

            };

            //register module
            lola.agent.registerAgent( page );

        })( lola );
    </script>
    <style>
        * { padding: 0; margin: 0; }
        p { margin: 10px 0; }
        input{ vertical-align: middle; }
        html{ background-color: rgb(245,245,245); }

        #grid, #curves, #pointHolder,#test
        {
            position:absolute;
            top: 0;
            left: 0;
        }

        #test {
            width: 3px;
            height: 0;
            background-color: red;
        }

        #easing {
            position:absolute;
            top: 50px;
            left: 500px;
            width: 350px;
        }

        #pointHolder {
            width: 500px;
            height: 500px;
        }

        #testBtn {
            position:absolute;
            top: 500px;
            left: 10px;
        }

        .draggable {
            cursor: move;
            z-index: 20;
        }

        .point {
            position: absolute;
        }

    </style>
</head>
<body>
    <pre id="easing"></pre>
    <canvas id="grid" width="851" height="500"></canvas>
    <canvas id="curves" width="851" height="500"></canvas>
    <div id="pointHolder"></div>
    <div id="test"></div>

    <input id="testBtn" type="button" value="test"/>

<body>
</html>